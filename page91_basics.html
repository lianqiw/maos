<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>MAOS: Fundementals</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="maos.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">MAOS
   </div>
   <div id="projectbrief">Multithreaded Adaptive Optics Simulator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page91_basics.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Fundementals </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The user is required to have a good understanding of the C fundamentals, like the pointer, to study and improve the code. Here we list a few to remind the user.</p>
<h1><a class="anchor" id="sect-array"></a>
Memory Access</h1>
<p>If you declare an array: <code>double a[1024];</code> the symbol actually contains the address of a 1024x8 byte memory region that is automatically allocated in the stack (malloc, calloc allocations memory in the heap). Suppose the address of the memory region is 0xFF00. Assignment <code>a[0]=1;</code> puts 1 in memory started at 0xFF00. And <code>a[1]=1;</code> puts 1 in memory started at 0xFF08.</p>
<p>Stack is the memory region allocated dynamically when calling a function. All variables reside in stack automatically disappear when the function returns.</p>
<p>Heap is the memory reservoir that persists during the life time of the executable. The functions <code>malloc</code>, <code>calloc</code>, <code>realloc</code> reserves memory in the heap while <code>free</code> removes the reservation.</p>
<h2><a class="anchor" id="sect-pointer"></a>
Pointers</h2>
<p>A pointer is a variable that stores the address of a memory region. For example, <code>void *p;</code> is a basic pointer that just stores the address and can not do any thing about the memory it points to. Its value can be assigned to any other non const vector or from any vector (1d or 2d).</p>
<p>However, a normal pointer like <code>double *p;</code> also contains information about the memory it points to. More specifically, the compiler know the length of each element so that it can compute the address offset of the elements, just like arrays. For example: </p><div class="fragment"><div class="line">double *p; //assume p=0xFF00.</div><div class="line">p[0]=1;    //stores 1 into memory region at 0xFF00</div><div class="line">p[1]=1;    //stores 1 into memory region at 0xFF08 because a double requires 8 bytes.</div><div class="line">p=p+1;     //now p=0xFF08, i.e., points to the next element, instead of 0xFF01 </div><div class="line">p[i]=1;    //is strictly equivalent to &lt;code&gt;*(p+i)=1;&lt;/code&gt; </div></div><!-- fragment --> <h2><a class="anchor" id="sect-1d-pointer"></a>
Array Pointers</h2>
<p>A pointer can be used to create and index an 1-dimensional (1-d) array in the heap: </p><pre class="fragment">double *p; //declares a double array pointer.
p=calloc(1024,sizeof(double)); //Allocate a memory block of 1024x8 byte and store its address in p.
p[0]=1;    //will assign 1 to the first number in the array.
</pre><h2><a class="anchor" id="sect-const"></a>
Constness</h2>
<p>Beware about a const pointer and pointer that points to constant memory regions: </p><div class="fragment"><div class="line">const double *p2;  //p2 is a pointer that points to a memory region that can not be changed. </div><div class="line">p2=p;              //ok</div><div class="line">p2[0]=1;           //illegal.</div><div class="line">double *const p3=p;//p2 is a constant pointer that can not have its value changed. </div><div class="line">p3=p;              //illegal</div><div class="line">p3[0]=1;           //ok</div></div><!-- fragment --> <h2><a class="anchor" id="sect-2d-pointer"></a>
Two Dimension Pointers</h2>
<p>A two-dimensional (2-d) pointer is like an array pointer. It stores the address of a memory region. However, unlike the array pointer, the compiler knows the length of the first dimension so that is can compute the memory location given 2-d index like <code>a</code>[2][3]; </p><div class="fragment"><div class="line">double (*p)[3]=calloc(3*2,sizeof(double)); //can be used in the same way as double a[2][3];</div></div><!-- fragment --><p> Notice that in 2-d indexing <code>a</code>[2][3], the last index changes the fastest. <br />
 </p>
<h1><a class="anchor" id="sect-maos-data"></a>
MAOS Data Types</h1>
<h2><a class="anchor" id="sect-maos-math"></a>
Fundamental Math Types</h2>
<p>MAOS defines and uses a few structs to manage memory for basic math types. Those types are defined in the <code>math</code> folder.</p>
<p>For example, <a class="el" href="structdmat.html">dmat</a> is used for 1-d or 2-d double array, and <a class="el" href="structcmat.html">cmat</a> is used for complex array. There is a predefined macro <a class="el" href="type_8h.html#afba9f40fe63e258302b2c472f9e9f386">P()</a> to help indexing the arrays: </p><div class="fragment"><div class="line">dmat *a=dnew(10,4); //allocates memory like double a[4][10]</div><div class="line">P(a,8,3)=1.;        //visits memory like a[3][8]</div><div class="line">P(a,39)=1.;         //visits memory as if it is 1d array.</div><div class="line">dfree(a);           //frees the memory</div><div class="line">cmat *a2=cnew(10,4);</div><div class="line">P(a2,7,3)=1.+1*I;</div><div class="line">cfree(a2);</div></div><!-- fragment --><p> Sparse arrays are managed using <a class="el" href="type_8h.html#structdsp">dsp</a> for double and <a class="el" href="type_8h.html#structcsp">csp</a> for complex. </p><div class="fragment"><div class="line">dsp *a3=dspnew(10,8,50); //10x8 array with maximum of 50 elements.</div></div><!-- fragment --><p> In addition, <a class="el" href="type_8h.html#structloc__t">loc_t</a> is used to describe x and y coordinate of uniformly spaced points. <a class="el" href="type_8h.html#structmap__t">map_t</a> is derived from <a class="el" href="structdmat.html">dmat</a> and used to describe 2-d array of opd or amplitude data with origin and resolution information.</p>
<p>Numerical arrays can be stores in <a class="el" href="type_8h.html#structcell">cell</a> arrays like in matlab. Different types have their specific cell definitions. For example, <a class="el" href="type_8h.html#structdcell">dcell</a> is used to contain <a class="el" href="structdmat.html">dmat</a> pointers, and <a class="el" href="type_8h.html#structccell">ccell</a> is used to contain <a class="el" href="structcmat.html">cmat</a> pointers. All cell arrays share the same struct layout and can be allocated using <a class="el" href="cell_8h.html#af5ecd7ec0a002a20b2f5af006c9ae47a">cellnew()</a> and deallocated using <a class="el" href="cell_8h.html#a088fe3d13e53e5d92d0b9c0165d92420">cellfree()</a>. However, access elements is better handled with specific cell types to avoid casting. The <a class="el" href="type_8h.html#structcell">cell</a> array can contain arbitrary points. </p><div class="fragment"><div class="line">dcell *c=cellnew(4,4);//allocates a cell array.</div><div class="line">P(c,2,1)=a;           //stores dmat pointer in a cell.</div><div class="line">cellfree(c);</div><div class="line"></div><div class="line">ccell *c2=cellnew(4,4);</div><div class="line">P(c2,2,3)=a2;</div><div class="line"></div><div class="line">dspcell*c3=cellnew(5,5);</div><div class="line">P(c3,3,2)=a3;</div><div class="line"></div><div class="line">cell *c4=cellnew(5,5);</div><div class="line">P(c4,0,0)=a;</div><div class="line">P(c4,1,0)=a2;</div><div class="line">P(c4,2,0)=a3;</div></div><!-- fragment --><p>Functions for those fundamental math types are defined using macros that works similarly to the C++ template.</p>
<h2><a class="anchor" id="sect-specific-type"></a>
Specific Types</h2>
<p>Specific calculation related types are often encapsulated in corresponding data types. Those types are defined in the <code>lib</code> folder.</p>
<h1><a class="anchor" id="sect-bin"></a>
Bin file format</h1>
<p>The <code>bin</code> file format is a simple custom binary format developed specifically to save telemetry data for <code>maos</code>. It can be converted to <code>fits</code> file using the supplied binary <code>bin/bin2fits</code>. The data in <code>bin</code> file are stored with the native endian-ness to facilitate memory mapping.</p>
<p>Data in <code>bin</code> file are stored as one or multiple consecutive <code>blocks</code> : </p><div class="fragment"><div class="line">block1 :self described data</div><div class="line">[block2] :(optional) self described data</div><div class="line">...</div></div><!-- fragment --><p>Each <code>block</code> is composed of a <code>header</code> and the <code>data</code>.</p>
<p>The <code>header</code> contains an optional part followed by a mandatory part. The optional part describes the data:</p>
<div class="fragment"><div class="line">0x6500: 4 byte uint</div><div class="line">length: 8 byte uint equal to the length of the following string</div><div class="line">string: variable length, padded to multiple of 8.</div><div class="line">length2: 8 byte uint equal to length</div><div class="line">0x6500: 4 byte uint</div></div><!-- fragment --><p>The mandatory part contains the type and size of <code>data</code> </p><div class="fragment"><div class="line">0x6600: 4 byte uint. Dummy, to facilitate memory alignment for mmap.</div><div class="line">magic:  4 byte uint. See sys/bin.h for all supported types</div><div class="line">nx:     8 byte uint. Inner dimension (fast changing index)</div><div class="line">ny:     8 byte uint. Outer dimension (slow changing index)</div></div><!-- fragment --><p>The <code>data</code> can be either array of fundamental data type or array of other arrays. For array of the fundamental data type, it is simply a copy of the data in the native endian-ness. For arrays of other arrays, the <code>magic</code> is set to 0x6420 and the data is composed of <code>nx*ny</code> <code>blocks</code>. The <code>data</code> part is skipped if either <code>nx</code> or <code>ny</code> equals to zero.</p>
<p>The <code>bin</code> file is readable in Matlab or Python using the supplied <code>read</code> or <code>readbin</code> routines. In <code>maos</code>, it can be either read or mapped to memory. For example The atmospheric screens are mapped to memory which enables using extra large atmospheric screens that may not fit in the memory and also enables sharing between concurrent maos runs that uses the same seed.</p>
<h1><a class="anchor" id="sect-guide"></a>
Guidelines</h1>
<p>When modifying the code, please adhere to the following guidelines.</p>
<p>Memory allocation:</p>
<ul>
<li>When declaring a struct, always initialize it to zero by calling calloc or memset, unless you have a good reason not to.</li>
<li>Use calloc instead of malloc to initialize the memory unless for large arrays that you will initialize immediately.</li>
</ul>
<p>Functions:</p>
<ul>
<li>The input parameters that is also the output should be grouped in the beginning, except when there is a main object for the algorithm.</li>
<li>In any function, there should usually be at most 1 return statement unless NULL or error code are returned pre-mature.</li>
<li>One utility function should be handle only one major mask to maximize reusability.</li>
<li>Input arguments to utility functions (in lib folder) should be basic types to maximize reusability. Input arguments to simulation functions can be wrapped (like simu) to maximum readability.</li>
</ul>
<p>Others:</p>
<ul>
<li>Avoid non constant static variables/pointers unless you have a good reason to do so. static variables are bad for multi-threading and hard to free after usage.</li>
<li>whenever modify something temporarily for debugging, make a warning. let it easily identifiable. not make a hidden bug.</li>
<li>Do not hard code adjustable parameters.</li>
<li>Always declare unchanged variables to constants. declare pointers as restrict if possible.</li>
<li>Do not include system headers in header files unless necessary. include those headers in .c file.</li>
<li>Avoid function casting. It will hide data type check and hide bugs. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->

   </ul>
 </div>
</body>
</html>
