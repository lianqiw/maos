<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>MAOS: Run simulations</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="maos.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">MAOS
   </div>
   <div id="projectbrief">Multithreaded Adaptive Optics Simulator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page30_run.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Run simulations </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#sect-run">Usage</a></li>
<li class="level1"><a href="#sect-config">Configuration Files</a></li>
<li class="level1"><a href="#sect-exe">Sample Runs</a></li>
<li class="level1"><a href="#advanced">Advanced configuration</a><ul><li class="level2"><a href="#sect-surface">Specifying Surface OPDs</a></li>
<li class="level2"><a href="#sect-wfs">WFS Configuration</a></li>
<li class="level2"><a href="#sect-perfevl">Point Spread Function</a></li>
<li class="level2"><a href="#sect-act">Actuator Slaving</a></li>
<li class="level2"><a href="#sect-sodium">Sodium range variation</a></li>
</ul>
</li>
<li class="level1"><a href="#skycoverage">Sky coverage</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="sect-run"></a>
Usage</h1>
<p>We assume that <code>maos</code> is already in the PATH so we can type <code>maos</code> to launch it.</p>
<p>Use the following command to get the help message: </p><div class="fragment"><div class="line">maos -h  #will print the help message and exit.</div></div><!-- fragment --><p>The valid command line arguments are listed as follows</p>
<div class="fragment"><div class="line">Usage: maos [OPTION...] [FILE]...</div><div class="line">maos is a simulation tool developed to adaptive optics systems</div><div class="line"></div><div class="line">Examples:</div><div class="line">maos -o result # Run the default configuration from default.conf and save results to \c result folder</div><div class="line"></div><div class="line">maos -c scao_ngs.conf sim.seeds=[1 10] -d -o scao_ngs override.conf</div><div class="line">         # Run a single conjugate natural guide star case, with seed 1 and 10</div><div class="line">         # detach from the terminal and output results to folder scao_ngs</div><div class="line">         # and read in overriding parameters stored in override.conf and chol.conf</div><div class="line"></div><div class="line">Options:</div><div class="line">-h, --help        to print out this message</div><div class="line">-d, --detach      to detach from terminal and run in background</div><div class="line">-f, --force       force starting simulation without scheduler</div><div class="line">-n, --nthread=N   Use N threads, default is 1</div><div class="line">-o, --output=DIR  output the results to DIR.</div><div class="line">-c, --conf=FILE.conf   Use FILE.conf as the baseline config instead of nfiraos.conf</div><div class="line">-p, --path=dir    Add dir to the internal PATH</div><div class="line">-g, --gpu=i       Use the i&#39;th gpu. 0 for the first. -1 to disable. default: automatic</div><div class="line">-G, --ngpu=N      Use a total of N gpus.</div><div class="line">-r, --run=host    Run the job in another host. Requires scheduler to be running.</div><div class="line"></div><div class="line">The following environment variables are supported</div><div class="line">MAOS_TOMOSCALE=1e12 Rebalance tomography terms for single precision calculation</div><div class="line">MAOS_PARALLEL=1      Set to 0 to disable parallel launch</div><div class="line">MAOS_NO_WFS=0        Set to 1 to disable all WFS calls</div><div class="line">MAOS_NO_EVL=0        Set to 1 to disable evaluation calls</div><div class="line">MAOS_NO_RECON=0      Set to 1 to disable reconstruction calls</div><div class="line">MAOS_KEEP_MEM=0      Set to 1 to keep some temporary memory between steps.</div><div class="line">MAOS_MEM_DEBUG=0     Set to 1 to enable malloc/free accounting. Useful to detect memory leak.</div><div class="line">MAOS_MEM_VERBOSE=0   Set to 1 to print detailed malloc/free info</div><div class="line">MAOS_LOG_LEVEL=0     Set logging level. -3: error and warning only,</div><div class="line">                           -2:  essential info, -1  useful info, 0:  all info,</div><div class="line">                           1:  debugging info, 2: more debugging info, 3: everything.</div></div><!-- fragment --><h1><a class="anchor" id="sect-config"></a>
Configuration Files</h1>
<p>All user modifiable options are configured through config files with suffix <code></code>.conf or key=value in the command line. The supplied default setup files are stored in sub-folder <code>config/maos</code>. The config files are organized in a modular way. One <code></code>.conf file can include another <code></code>.conf file with <code>include=filename.conf</code>. The <code></code>.conf files in <code>config/maos</code> file are self-documented.</p>
<p>All the options are in the form of <code>key=value</code>. The usually convention is: if the entry in <code>parms</code> called <code>parms-&gt;wfs.thetax</code>, the entry in .conf file will be in the form <code>wfs.thetax=value</code>.</p>
<p>Some of the rules are:</p>
<ul>
<li>array values must be embraced by <code></code>[] and separated by <code></code>,</li>
<li>string are embraced by double or single quotes ('' or "").</li>
<li>A line ended with \ will be concatenated with the next line.</li>
<li>Anything after comment string # will be ignored during reading.</li>
</ul>
<p>The config <code>key=value</code> can be specified multiple times for any key, in which case the latter value will override the previous value, except when <code>key+=value</code> is used which causes it to append instead. The software will complain and exit if any <code>key=value</code> pair is not understood or required but not provided.</p>
<p>The recommended way to organize config files for a specific problem is to keep a baseline <code></code>.conf file in sub-folder <code>config/maos</code> in the source folder that specify all the necessary <code>key=value</code> entries through optionally including other <code></code>.conf files. The default entry is <code>default.conf</code> unless <code>-c file.conf</code> switch is supplied in the command line.</p>
<p>Embed the overriding options in the command line (embrace it with quote if the option contains spaces, like arrays) or put in one or multiple overriding file (in the simulation folder, not inside -c config/maos) to override the values you want to change from the baseline.</p>
<p>The <code></code>.conf files in the <code>config/maos</code> folder are only modified during code development and should not be modified by the end user. Use overriding <code></code>.conf files in simulation folders or embed configurations in the command line to modify the values.</p>
<p>In the <code>config/maos</code> folder, there are a few sample <code></code>.conf files that is complete for each configuration:</p>
<ul>
<li><a class="el" href="mcao_lgs.html">mcao_lgs.conf</a> for NFIRAOS mcao simulations (the default),</li>
<li><a class="el" href="mcao_ngs.html">mcao_ngs.conf</a> for NGS mcao simulations</li>
<li><a class="el" href="scao_lgs.html">scao_lgs.conf</a> for single conjugate LGS simulation</li>
<li><a class="el" href="scao_ngs.html">scao_ngs.conf</a> for single conjugate NGS simulation.</li>
<li><a class="el" href="scao_pwfs.html">scao_pwfs.conf</a> for Pyramid WFS NGS simulation.</li>
</ul>
<p>Each of this file include a few other <code></code>.conf files by specifying <code>include=<code>filename.conf</code></code>, for example, all these baseline <code></code>.conf files include the following common <code>.conf</code> files that is independent on the simulation mode or geometry.</p>
<ul>
<li><a class="el" href="sim.html">sim.conf</a> to specify general simulation parameters such as loop gain, number of time steps, etc,</li>
<li><a class="el" href="recon.html">recon.conf</a> to specify reconstruction parameters in closed loop,</li>
<li><a class="el" href="dbg.html">dbg.conf</a> to specify debugging parameters.</li>
</ul>
<p>The following list the exclusive <code>.conf</code> files used to specified particular set of configurations. Each group should only appear once.</p>
<ul>
<li><code>atm_*.conf</code>: set to a different preconfigured turbulence profile.</li>
<li><code>dm_*.conf</code>: set deformable mirror configuration.</li>
<li><code>fov_*.conf</code>: set the science FoV.</li>
<li><code>wfs_*.conf</code>: set the wfs group type</li>
</ul>
<p>For example, the baseline configuration for TMT MCAO system <code>mcao_lgs.conf</code> includes <code>atm_mk13n50p.conf</code> to specify MK13N median seeing turbulence profile, <code>dm_dual.conf</code> to specify dual DM system, <code>wfs_lgs_ttf_tt.conf</code> to specify WFS configuration as LGS WFS plus TTF NGS WFS plus TT NGS WFS, <code>fov_sq34.conf</code> to specify the science FoV as simpson weighting on 3x3 points in the square 34x34" FoV.</p>
<p>See page31_example for more detailed explanations.</p>
<h1><a class="anchor" id="sect-exe"></a>
Sample Runs</h1>
<p>To run predefined AO modes</p>
<div class="fragment"><div class="line">maos -o mcao # default is dual conjugate AO, save results to folder mcao</div><div class="line">maos -c mcao_ngs.conf  # NGS MCAO</div><div class="line">maos -c scao_ngs.conf  # NGS SCAO</div><div class="line">maos -c scao_pwfs.conf # NGS SCAO using PWFS</div><div class="line">maos -c scao_lgs.conf  # LGS SCAO</div><div class="line">maos -c examples/keck_lgs.conf #KECK LGS AO</div></div><!-- fragment --><p>To customize number of components</p>
<div class="fragment"><div class="line">maos dm_single.conf wfs_lgs_only.conf recon.glao=1 # LGS GLAO</div><div class="line">maos dm_triple.conf dm.dx=0.3  # triple DM with 0.3 actuator pitch</div><div class="line">maos wfs_lgs_ttf_tt_twfs.conf  # with LGS, TTF, TT, and TWFS</div><div class="line">maos evl_x.conf #evaluate performance along x axis.</div></div><!-- fragment --><p>Change aperture</p>
<div class="fragment"><div class="line">maos aper.d=[10]    # 10 meter circular</div><div class="line">maos aper.d=[10, 1] # 10 meter annular diameter with 1 meter inner obscuration</div><div class="line">maos aper.d=[10, 1] aper.fnamp=aper.bin # with supplied amplitude map. Diameters need to match.</div></div><!-- fragment --><p>Change turbulence</p>
<div class="fragment"><div class="line">maos atm_mk13n25p.conf #use another predefined profile. The default is atm_mk13n50p.conf</div><div class="line">maos atm.r0z=0.1     # change r0 at zenith to 0.1m</div><div class="line">maos sim.zadeg=30    # change zenith angle to 30 degrees</div><div class="line">maos atm_single.conf # use single ground layer turbulence</div></div><!-- fragment --><p>Configuring WFS. Adjust the number of elements depending on how many powfs is in use. A powfs is a type of WFS. Each type can have multiple WFS.</p>
<div class="fragment"><div class="line">maos powfs.noisy=[0]     # use noise free WFS for all wfs types</div><div class="line">maos powfs.noisy=[1 0 0] # use noise free WFS for wfs type 1 and 2.</div><div class="line">maos powfs.phystep=[-1]  # use geometric wfs instead of physical optics wfs for all</div></div><!-- fragment --><p>Adjust the controller</p>
<div class="fragment"><div class="line">maos sim.ephi=0.3 #Change gain of the main integrator to 0.3</div></div><!-- fragment --><h1><a class="anchor" id="advanced"></a>
Advanced configuration</h1>
<h2><a class="anchor" id="sect-surface"></a>
Specifying Surface OPDs</h2>
<p>We can optionally setup one or more static surfaces that cover science fields and/or wavefront sensors. Each surface file must contain a 2-d array of the OPD with a header specifying the following keys. If header is not available, the OPD is assumed to have 1/64 sampling and centered on the pupil.</p>
<div class="fragment"><div class="line">dx  the sampling in x direction (first dimension).</div><div class="line">dy  the sampling in y direction (second dimension).</div><div class="line">ox  the origin in x direction.</div><div class="line">oy  the origin in y direction.</div><div class="line">h   the height conjugation of this surface</div><div class="line">vx  the frozen flow wind speed along x of this surface (0 for static)</div><div class="line">vy  the frozen flow wind speed along y of this surface (0 for static)</div></div><!-- fragment --><p>Optionally, the header can also include the following keys to indicate its coverage</p>
<div class="fragment"><div class="line">SURFNAME=name       #name of the surface. M1 or M2 for the primary or secondary mirror</div><div class="line">SURFEVL=[1 1 1 ...] #length: nevl. 1: enabled for this science evaluation direction (assume all 1 if omitted)</div><div class="line">SURFWFS=[1 1 1 ...] #length: nwfs. 1: enabled for this WFS (assume all 1 if omitted)</div></div><!-- fragment --><p>Use the <code>write</code> mex routine, <code>writebin.m</code>, or <code>aolib.writebin</code> to write the bin file: </p><div class="fragment"><div class="line">write(OPD, header, &#39;opd1.bin&#39;)</div></div><!-- fragment --><p> Or simply use fits format. Put the list of surface file names in key <code>surf</code>. </p><div class="fragment"><div class="line">maos surf=[&#39;opd1.bin&#39;,&#39;opd2.bin&#39;, &#39;opd3.fits&#39;]</div></div><!-- fragment --><p>It is also possible to specify NCPA with inline configuration: </p><div class="fragment"><div class="line">maos surf=[&quot;&#39;r0=0.1;slope=-4;SURFEVL=1;&#39;, &#39;r0=0.2; slope=-4;SURFWFS=1 1 1 1 1 1 0 0 0&#39;&quot;]</div><div class="line">maos surf=[&quot;&#39;r0=0.1;slope=-4;L0=30;nx=2048;dx=1./64;SURFEVL=1;SURFWFS=0&#39;&quot;]</div></div><!-- fragment --><p> The double quote is necessary here to group the single quoted entries together.</p>
<p>The amplitude map of the telescope can be specified with <code>aper.fnamp=aper.bin</code> with a similar data format, with OPD replaced by amplitude map between 0 and 1. By default, NCPA are calibrated, use <code>sim.ncpa_method=0</code> to disable calibration</p>
<p>We can also setup one or more tilted M3 surfaces that are common to science fields and wavefront sensors. Put the list of surface files in key <code>tsurf</code>. Each surface file must contain a 2-d array with a header specifying the following keys:</p>
<div class="fragment"><div class="line">dx    the sampling in x direction (first dimension).</div><div class="line">dy    the sampling in y direction (second dimension).</div><div class="line">ox    the origin in x direction.</div><div class="line">oy    the origin in y direction.</div><div class="line">txdeg the x tilt angle in degrees wrt beam (90 is perp)</div><div class="line">tydeg the y tilt angle in degrees wrt beam (90 is perp)</div><div class="line">ftel  the telescope effective focal length</div><div class="line">fexit the distance between the exit pupil and the focus</div><div class="line">fsurf the distance between the center of the M3 surface and the focus.</div></div><!-- fragment --><h2><a class="anchor" id="sect-wfs"></a>
WFS Configuration</h2>
<p>The WFS configuration are mostly supplied in <code>powfs</code>, which applies to all the wfs belonging to this type. For wfs specific parameters, use <code>wfs</code>. If there is a single number in <code>powfs</code>.[key], it applies to all powfs. The follow lists a few common options</p>
<div class="fragment"><div class="line">powfs.noisy=[0]         #set noise free for all powfs</div><div class="line">powfs.noisy=[1 0 0]     #set noise free only for powfs 1 and 2.</div><div class="line">powfs.phystep=[0 -1 -1] #use physical optics wfs for the first type (high order), and geometric for the remaining (t/t/f)</div><div class="line">powfs.phytype=[1 2 2]   #pixel processing 1: use matched filter, 2: cog</div><div class="line">powfs.siglev=[900 100 100] #specify signal level for physical optics wfs mode at sim.dtref Hz per pixel.</div><div class="line">powfs.bkgrnd=[10 0 0]   #specify background level at sim.dtref Hz per pixel</div><div class="line">powfs.rne=[3 1 1]       #specify read out noise for physical optics wfs mode</div><div class="line">powfs.nearecon=[20 2 1] #specify noise equivalent angle in milli-arcsecond for geometric wfs mode</div><div class="line">powfs.neasim=[20 2 1]   #specify nea for simulation. -1 to match nearecon.</div></div><!-- fragment --><p>WFS specific parameters usually include WFS coordinate </p><div class="fragment"><div class="line">wfs.thteax=[]           #specify the x coordinate in arcsec</div><div class="line">wfs.thetay=[]           #specify the y coordinate in arcsec</div></div><!-- fragment --><h2><a class="anchor" id="sect-perfevl"></a>
Point Spread Function</h2>
<p>Maos only computes RMS averaged wavefront errors by default, which are saved to <code>Res_</code>[seed].bin. When desired, PSFs computing can be enabled for some or all of the science evaluation directions. Modify <code>evl.thetax</code> , <code>evl.thetay</code> , and <code>evl.wt</code> to modify evaluation directions and relative weighting for field averaging. Use the following parameters to enable PSF computation. </p><div class="fragment"><div class="line">maos evl.psfisim=20 evl.psfmean=1 # start averaging from step 20, save averaged PSF once in the end.</div><div class="line">maos evl.psfmean=1 evl.psfol=1   # also include open loop PSF</div><div class="line">maos evl.psfmean=1 evl.psfsize=[1024,1024]     # only save center part 1024x1024 of the PSF</div><div class="line">maos evl.psfmean=1 evl.psfgridsize=[4096,4096] # specify PSF FFT grid size to control the sampling.</div></div><!-- fragment --><h2><a class="anchor" id="sect-act"></a>
Actuator Slaving</h2>
<p>Due to pupil obscuration, there may be actuators that are not sensed by the WFS and therefore cannot be accurately reconstructed. The actuator coupling coefficient, computed using DM fitting ray tracing (HA in Minimum variance reconstruction) or gradient interaction matrix (GA in least squares reconstruction), is used to determine how accurately an actuator is sensed/controlled. Activated by </p><pre class="fragment">  lsr.actslave=1 #or 2, for lsr
  fit.actslave=1 #or 2, for mvr
</pre><ul>
<li><code>actslave=1</code> enables implementation with threshold <code></code>.actthres. When an actuator is outside of the pupil, its coupling coefficient is usually very small. When it is below lsr.acthres, its value is slaved to its neighboring actuators.</li>
<li><code>actslave=2</code> in addition enables implementation with threshold <code></code>.actthres2. When an actautor is hidden by secondary mirror support struts, it may still have relatively strong coupling, but regions separated by the structs may have different piston values, so called island effect. The mitigation method is to limit the value gap around such actautors whoes coupling is below .actthres2.</li>
</ul>
<h2><a class="anchor" id="sect-sodium"></a>
Sodium range variation</h2>
<p>The sodium range variation is specified through the LLT configuration key <code>llt.fnrange</code> in <a class="el" href="llt__c_l.html">llt_CL.conf</a> or <a class="el" href="llt__s_l.html">llt_SL.conf</a>. When supplied by user, use <code>powfs0_llt.fnrange</code>. The file should contain additional change (wrt fnprof) of sodium height in meters with dimension nx1 or nxnLGS where <code>n</code> can be less than, equal to or greater than the length of simulation and nLGS is the number of LGS in this powfs (6 for NFIRAOS).</p>
<p>The range variation is simulated by adding corresponding focus mode to LGS WFS wavefront.</p>
<h1><a class="anchor" id="skycoverage"></a>
Sky coverage</h1>
<p>The sky coverage simulation is done in two parts. <code>maos</code> is run first used to prepare NGS mode and WFS PSF time series:</p>
<p><code>maos</code> -c nfiraos_lgs.conf skyc_10.conf -o 50p_za0_ncpa</p>
<p>The second step is to run <code>skyc</code> in the sky sim folder <code>cd</code> 50p_za0_ncpa/skysim <code>skyc</code> -d -o APD_JHKs_typeImr</p>
<p>The results are stored in <code>Res1_1.bin</code> for <code>maos</code> seed 1, <code>skyc</code> seed 1. There are <code>nsky=500</code> columns with the following row definitions:</p>
<p>0. Total residual error</p><ol type="1">
<li>Residual atmpheric (included in <code>maos</code> simulations) error</li>
<li>Residual atmosphere error only in tip/tilt modes.</li>
<li>Residual windshake if skyc.psd_is is set and skyc.addws=0. (deprecated use)</li>
<li>0 (not used) <hr/>
</li>
</ol>
<p>See <a class="el" href="page40_results.html">Simulation Results</a> for further explanation and results interpretation. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->

   </ul>
 </div>
</body>
</html>
