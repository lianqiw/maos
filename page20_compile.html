<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<title>MAOS: Compile the Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="maos.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">MAOS
   </div>
   <div id="projectbrief">Multithreaded Adaptive Optics Simulator</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('page20_compile.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Compile the Code </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md0">Compiling</a><ul><li class="level2"><a href="#autotoc_md1">Prerequisites</a></li>
<li class="level2"><a href="#autotoc_md2">Download the code</a><ul><li class="level3"><a href="#autotoc_md3">Option 1 (preferred)</a></li>
<li class="level3"><a href="#autotoc_md4">Option 2 (snapshot)</a></li>
<li class="level3"><a href="#autotoc_md5">Option 3 (released)</a></li>
<li class="level3"><a href="#autotoc_md6">Option 4 (binary)</a></li>
</ul>
</li>
<li class="level2"><a href="#autotoc_md7">Compile the Code</a></li>
<li class="level2"><a href="#autotoc_md8">Compiler options (Optional)</a></li>
<li class="level2"><a href="#autotoc_md9">GPU acceleration (Optional)</a></li>
<li class="level2"><a href="#autotoc_md10">Matlab Mex Routines (Optional)</a></li>
<li class="level2"><a href="#autotoc_md11">Installing GTK+ in MAC OS and Compile Monitor, Drawdaemon (Optional)</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md12">Graphical User Interface</a><ul><li class="level2"><a href="#autotoc_md13">Monitor</a></li>
<li class="level2"><a href="#autotoc_md14">Drawdaemon</a></li>
<li class="level2"><a href="#autotoc_md15">Plotting results</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md16">Python Scripts</a><ul><li class="level2"><a href="#autotoc_md17">Interface to MAOS</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md0"></a>
Compiling</h1>
<h2><a class="anchor" id="autotoc_md1"></a>
Prerequisites</h2>
<ul>
<li>Posix compatible platform: Linux, macOS, or WSL for windows. BSDs may work but are not actively verified.</li>
<li>C11 compliant compiler (GCC, clang, or icx).</li>
<li>System utils: make, cmake, tar, bzip2, wget or curl</li>
<li>If compile from git repo, autotools (autoconf, automake, libtool) are needed.</li>
<li>FFTW version 3. Will download from MAOS site if not available in the system.</li>
<li>Optimized blas and lapack. Blas and lapack can usually be installed through the linux distribution official repository. Will download from MAOS site if not available in the system. use &ndash;enable-mkl to force using Inte MKL.</li>
<li>Cholmod. For sparse matrix cholesky factorization. Will download from MAOS site if not available in the system.</li>
<li>(Optional) CUDA. For GPU acceleration.</li>
<li>(Optional) GTK+. For drawdaemon and monitor.</li>
<li>(Optional) libwebsockets. For web based job monitoring. It requires <code>cmake</code> to compile. Will download from MAOS site if not available in the system.</li>
<li>(Optional) CMocka. For unit testing.</li>
<li>(Optional) Doxygen. For generating documentation (this website)</li>
</ul>
<p>In linux, use the native package manager (apt for Debian/Ubuntu, rpm for Fedora/Centos/RHEL and derivatives) to install.</p>
<p>In macOS, it is convenient to use homebrew (<a href="https://brew.sh/">https://brew.sh/</a>) to install.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Download the code</h2>
<p>We recommend using different folders to 1) store the source code, 2) compile the code (different directory can be used for different compiling options), and 3) run simulations.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
Option 1 (preferred)</h3>
<p>The preferred method is to use the always up-to-data Git version: </p><div class="fragment"><div class="line">cd ~/work/programming</div><div class="line">git clone https://github.com/lianqiw/maos.git maos</div><div class="line">cd maos</div><div class="line">./autogen.sh</div><div class="line">export src_dir=$(pwd)</div></div><!-- fragment --><h3><a class="anchor" id="autotoc_md4"></a>
Option 2 (snapshot)</h3>
<p>Download the tag version that is not formally released:</p>
<div class="fragment"><div class="line">cd ~/work/programming</div><div class="line">curl -L https://github.com/lianqiw/maos/archive/refs/tags/v2.8.tar.gz -o maos.tar.gz</div><div class="line">tar xvf maos.tar.gz</div><div class="line">cd maos-2.8</div><div class="line">./autogen.sh</div><div class="line">export src_dir=$(pwd)</div></div><!-- fragment --><h3><a class="anchor" id="autotoc_md5"></a>
Option 3 (released)</h3>
<p>There are released version that comes with <code>configure</code>. Use this if the utilities mentioned above are not available. In this case, do not try to update the <code>configure.ac</code> file which will trigger regeneration of <code>configure</code> and require these utilities.</p>
<div class="fragment"><div class="line">cd ~/work/programming</div><div class="line">curl -L https://github.com/lianqiw/maos/archive/refs/tags/maos-2.8.0.tar.gz</div><div class="line">cd maos_2.8.0</div><div class="line">export src_dir=$(pwd)</div></div><!-- fragment --><h3><a class="anchor" id="autotoc_md6"></a>
Option 4 (binary)</h3>
<p>Instead of compiling the code, there are also pre-compiled binaries that can be downloaded. This option works the best when there is no desire to modify the code.</p>
<div class="fragment"><div class="line">cd ~/work/maos</div><div class="line">#choose one below:</div><div class="line">#curl -L https://github.com/lianqiw/maos/releases/download/v2.8/maos_linux_amd64-2.8.0.tar.bz2 #for linux</div><div class="line">#curl -L https://github.com/lianqiw/maos/releases/download/v2.8/maos_macos_amd64-2.8.0.tar.bz2 #for macos </div><div class="line">#curl -L https://github.com/lianqiw/maos/releases/download/v2.8/maos_macos_aarch64-2.8.0.tar.bz2 #for macos apple silicon</div><div class="line">tar xvf maos_*.bz2</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md7"></a>
Compile the Code</h2>
<p>Next we create another folder, where we are going to compile the code. example:</p>
<div class="fragment"><div class="line">cd ~/work/maos</div><div class="line">mkdir optim &amp;&amp; cd optim</div><div class="line">$src_dir/configure</div><div class="line">make -j4 #this will compile using 4 threads.</div></div><!-- fragment --><p> You can replace <code>optim</code> with any directory name of your choice. The compiled executable is maos in the sub-folder <code>bin</code> of the compiling folder. You do not have to do <code>make install</code> to run the simulations, but if not, then you need to add <code>optim/bin</code> to your executable path (e.g. update your .bash_profile or .zshenv file <code>$PATH</code> variable).</p>
<h2><a class="anchor" id="autotoc_md8"></a>
Compiler options (Optional)</h2>
<p>The default compiler for the system is used with optimization flags. There are a few optional switches or additional components that can be enabled when calling configure.</p>
<p>To use a different compiler or enable debugging: </p><div class="fragment"><div class="line">$src_dir/configure CC=icc    #ICC compiler</div><div class="line">$src_dir/configure CC=clang  #clang compiler. Also used for compiling cuda code if cuda is detected.</div><div class="line">$src_dir/configure CC=gcc4.5 #use gcc4.5</div><div class="line">$src_dir/configure --enable-debug #enable debugging (debug is not enabled by default)</div><div class="line">$src_dir/configure --disable-openmp #Use pthreads instead of openmp (openmp is the default)</div><div class="line">$src_dir/configure --disable-double #Use single precision (double is the default)</div><div class="line">$src_dir/configure --disable-scheduler #disable the built-in scheduler (for CPU cluster with job management)</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
GPU acceleration (Optional)</h2>
<p>To enable GPU computing, first install nvidia graphics driver and cuda software development toolkit (SDK), and then issue the following command to ensure graphics configuration is correct: <code>nvidia-smi</code>. You should see all your nvidia gpus are listed. When <code>clang</code> is used as the C compiler, it will be used instead of <code>nvcc</code> to compute the <code>cuda</code> code.</p>
<p>The configure can automatically detect cuda if <code>nvcc</code> is in the path, or if cuda is installed in <code>/usr/local/cuda</code>. For other locations, you need to pass the cuda directory to configure:</p>
<p><code>$src_dir/configure --with-cuda=$cuda_dir</code></p>
<p>When GPU compute is compiled in <code>maos</code> and Nvidia GPUs are available, <code>maos</code> will make use of all suitable GPUs to run simulation. If that is not desirable, the GPU compute can be disabled at run time by passing <code>-g-1</code> to <code>maos</code>. Different set of GPU can also be selected by passing one or multiple <code>-gi</code> or <code>-Gn</code>:</p>
<div class="fragment"><div class="line">maos -g-1    #disable GPU compute</div><div class="line">maos -g0 -g2 #Only use gpu 0 and 2</div><div class="line">maos -G2     #Automatically choose 2 gpus.</div></div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
Matlab Mex Routines (Optional)</h2>
<p>To compile mex routines for matlab, pass the matlab directory to configure if it is not in <code>$PATH:</code> </p>
<div class="fragment"><div class="line">$src_dir/configure --with-matlab=$matlab_dir</div></div><!-- fragment --><p>The compiled mex routines are in <code>mex</code> folder in the compilation directory.</p>
<ul>
<li>The <code>read()</code> and <code>write()</code> are for handling .bin and .fits files.</li>
<li>The <code>aolib()</code> exports many useful routines for use in <code>matlab</code>. Run <code>aolib()</code> to see the list of available functions.</li>
<li>The <code>maos()</code> can be used to run maos within matlab. Run <code>maos()</code> to see instructions.</li>
</ul>
<h2><a class="anchor" id="autotoc_md11"></a>
Installing GTK+ in MAC OS and Compile Monitor, Drawdaemon (Optional)</h2>
<p>For macOS, it is simplest to install gtk and gtk-mac-integration using homebrew (or macport). For manual install, follow the instructions on <a href="https://www.gtk.org/docs/installations/">page</a> to install gtk+ for osx and configure the envirionmental parameters. Version 2 and 3 are supported. Make sure <code>pkg-config</code> is in the <code>PATH</code>.</p>
<p>Now rerun <code>autogen.sh</code>, <code>configure</code> and <code>make</code>. Monitor and drawdaemon should appear in <code>bin</code> folder now. To select gtk version when multiple ones are available: </p><div class="fragment"><div class="line">$src_dir/configure --disable-gtk-3 #disables gtk-3</div><div class="line">$src_dir/configure --disable-gtk-2 #disable gtk-2 (gtk-3 is used by default)</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md12"></a>
Graphical User Interface</h1>
<p>When GTK+ libraries are found in the system, additional executables will be compiled, <code>drawdaemon</code>, <code>drawres</code>, <code>drawbin</code> and <code>monitor</code> in the <code>bin</code> folder.</p>
<ul>
<li>The plotting utility <code>drawdaemon</code> is launched automatically when plotting commands are issued in simulation (<code>maos plot.all=1</code>) or in post processing with <code>drawres</code> or <code>drawbin</code> </li>
<li>The monitoring utility <code>monitor</code> can be used to monitor jobs in this and linked machines.</li>
<li>The <code>drawres</code> can be used to automatically plot the results folder.</li>
<li>The <code>drawbin</code> can be used to automatically plot the OPDs or maps.</li>
</ul>
<h2><a class="anchor" id="autotoc_md13"></a>
Monitor</h2>
<p>In order to use monitor to monitor jobs in different machines, follow these steps:</p>
<p>Create a folder .aos in your home folder, create two files in there. Put these files in all the machines you want to monitor.</p>
<ul>
<li><code>~/.aos/hosts</code> Each line contains a machine's hostname you want to monitor. It also supports the full format <code>prettyname=full_hostname:port</code></li>
<li><code>~/.aos/port</code> contains the port you want the <code>scheduler</code> to bind to so that the monitor can connect to it. Any non-privileged port numbers are fine (like 10000). Different users should have different port number. The port has to be the same on all the machines unless explicitly specified in <code>hosts</code>. If not set, the number will be automatically computed based on username. Make sure the firewall allows them.</li>
<li>After modifying the two files above, the <code>scheduler</code> should be killed and restarted (by simply running <code>maos</code> once.)</li>
<li>Please be aware that no authentication is performed. The user should make sure such ports are protected.</li>
<li>When <code>libwebsockets</code> is enabled, there is also a browser based interface. The address is printed in the beginning of <code>maos</code> log message.</li>
</ul>
<h2><a class="anchor" id="autotoc_md14"></a>
Drawdaemon</h2>
<p>Once the monitor is running, it will display running jobs on each connected host. Right click on a running job and select <code>Plot selected jobs</code> will launch drawdaemon and start plotting the telemetry data in realtime. This works for local and remote host. Multiple drawdaemon windows can be started for the same or different jobs.</p>
<p>An alternative way to launch drawdaemon is to include <code>plot.setup=1</code> <code>plot.run=1</code> or <code>plot.all=1</code> in maos command line.</p>
<p>Remote plotting: when a job is running remotely or in a headless machine, and <code>drawres</code>, <code>drawbin</code>, or <code>maos</code> plotting is issued, the <code>monitor</code> can open a <code>drawdaemon</code> in the local computer and plot remotely.</p>
<h2><a class="anchor" id="autotoc_md15"></a>
Plotting results</h2>
<p><code>drawres result_folder</code> can be used to plot the results. Wildcards are supported to match many folders. It will launch drawdaemon using an active monitor in a remote machine if the current shell does not have DISPLAY set. This can be used to view results remotely.</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Python Scripts</h1>
<p>MAOS comes with a few useful python routines location in <code>scripts/</code> folder:</p>
<ul>
<li><code>readbin.py</code> contains <code>readbin</code> that can read <code>bin</code> or <code>fits</code> files.</li>
<li><code>aotools.py</code> contains a few useful routines for data processing.</li>
<li><code>draw.py</code> contains routines to draw <code>opd</code> defined on coordinate <code>loc</code>. Use <code>draw(loc, opd)</code> or <code>draw(map)</code> where <code>map</code> is a 2d array.</li>
<li><code>maos_result.py</code> contains routines <code>maos_res</code> to read and process <code>MAOS</code> results. It also imports <code>libaos.py</code> and <code>draw.py</code> </li>
<li><code>libaos.py</code> contains routines that wraps <code>MAOS</code> library routines via <code>aolib.so</code> and <code>ctypes</code>. It contains <code>read</code> and <code>write</code> that can also read and write <code>bin</code> and <code>fits</code> files.</li>
<li><code>lib2py.py</code> generates <code>libaos.py</code>. Similarly <code>lib2mex.py</code> generates MATLAB mex routines.</li>
<li><code>maos_client</code> provides an interface to a running maos session. See next subsection.</li>
</ul>
<p>For <code>libaos.py</code> to work, an environment variable <code>MAOS_AOLIB</code> need to set to the path of <code>aolib.so</code>.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Interface to MAOS</h2>
<p>It is possible to retrieve or override MAOS internal data when it is running. See the following steps:</p>
<p>First, set up shell environment so that the libaos.py can find it.</p>
<ul>
<li><code>export MAOS_AOLIB=\path\to\bin\aolib.so</code></li>
</ul>
<p>Then open <code>ipython</code> (or <code>python</code>) and run the following</p>
<ul>
<li><code>import</code> <code>maos_client</code> # import the module</li>
<li><code>maos_client.connect(host,port)</code> # the host and port is the same as used by monitor</li>
<li><code>maos_client.get_list()</code> # get list of available variables</li>
<li><code>maos_client.get_var(name)</code> # get variable with the name</li>
<li><code>maos_client.get_all()</code> # get all variables</li>
<li><code>maos_client.pause(0)</code> # unpause maos</li>
<li><code>maos_client.pause(1)</code> # pause or step maos. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->

   </ul>
 </div>
</body>
</html>
